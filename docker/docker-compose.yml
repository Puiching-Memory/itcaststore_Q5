services:
  # PostgreSQL 数据库服务
  postgres:
    image: postgres:17-alpine
    container_name: itcaststore_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: itcaststore
      POSTGRES_USER: itcaststore
      POSTGRES_PASSWORD: itcaststore
      TZ: Asia/Shanghai
    ports:
      - "5433:5432"
    volumes:
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - postgres_data:/var/lib/postgresql/data
    networks:
      - itcaststore_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U itcaststore"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 后端应用服务（Spring Boot - 支持热重载）
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: itcaststore_backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/itcaststore
      - SPRING_DATASOURCE_USERNAME=itcaststore
      - SPRING_DATASOURCE_PASSWORD=itcaststore
      - SPRING_DEVTOOLS_RESTART_ENABLED=true
      - SPRING_DEVTOOLS_LIVERELOAD_ENABLED=true
    ports:
      - "8080:8080"
      - "35729:35729"  # LiveReload 端口
    volumes:
      # 挂载整个后端目录，实现代码热重载
      - ../backend:/app
      # Maven 本地仓库缓存（加速构建）
      - maven_cache:/root/.m2
      # 上传文件目录
      - uploads_data:/app/uploads
    networks:
      - itcaststore_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/products", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # 前端应用服务（Vite 开发服务器 - 支持热重载）
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: itcaststore_frontend
    restart: unless-stopped
    depends_on:
      - backend
    environment:
      - TZ=Asia/Shanghai
      - DOCKER_ENV=true  # 标识在 Docker 环境中运行
    ports:
      - "5173:5173"  # Vite 开发服务器端口
    volumes:
      # 挂载整个前端目录，实现代码热重载
      - ../frontend:/app
      # 使用匿名卷保护 node_modules，避免被宿主机覆盖
      - /app/node_modules
    networks:
      - itcaststore_network

  # Langflow 智能体服务
  langflow:
    image: langflowai/langflow:latest
    container_name: itcaststore_langflow
    restart: unless-stopped
    user: "0:0"  # 以 root 运行以避免卷权限问题
    ports:
      - "7860:7860"          # 宿主机访问 Langflow：http://localhost:7860
    volumes:
      - langflow_data:/app/.langflow  # 持久化 Langflow 配置和数据
    environment:
      - LANGFLOW_PORT=7860
      - LANGFLOW_CONFIG_DIR=/app/.langflow  # 指定配置目录，与卷挂载路径一致
      - LANGFLOW_DATABASE_URL=sqlite:////app/.langflow/langflow.db  # 将数据库放在持久化卷内
    networks:
      - itcaststore_network

networks:
  itcaststore_network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  uploads_data:
    driver: local
  langflow_data:
    driver: local
  maven_cache:
    driver: local
